flowchart TD
%% ============================================================================
%% TRAINING SCREEN POLICY (Unity Cup) â€” mirrors decide_action_training(...)
%% ASCII-only labels, no parentheses in node text, explicit thresholds
%% ============================================================================

%% -------------------------- LEGEND / DEFAULTS -------------------------------
subgraph LEGEND[Legend thresholds and terms]
  L1[High SV = 3.5 or more]
  L2[Good SV = 2.5 or more]
  L3[Late SV = 2.0 or more]
  L4[Low gate SV = 1.75 or more]
  L5[WIT decent SV = 1.5 or more]
  L6[Undertrained threshold = 6 percent vs reference]
  L7[Priority guard diff = 0.75 or less]
  L8[Priority guard top3 minimum SV = 0.5 or more]
  L9[Exceptional SV = 4.1 or more]
  L10[Energy low rest gate = 35 percent]
  L11[Race energy gate when not summer = 68 percent]
  L12[Summer soon one turn energy bands
      75 to 96 WIT
      at or below 70 REST]
  L13[Summer soon two or fewer turns and energy at or below 90 pick WIT if SV at or above 0.5]
end

%% ---------------------------- ENTRY ----------------------------------------
START([Training screen ready\nSV already computed by scoring block]) --> DISTN{Distribution nudge\nTop 3 priority stat undertrained\nby 6 percent or more\nand close to best SV?}

%% --------------------- DISTRIBUTION NUDGE ----------------------------------
DISTN -->|Yes and meets flexible gap and SV ok| PICK_UNDER[[TRAIN MAX on best tile of that undertrained stat]]
DISTN -->|No| SV35{Any allowed tile\nSV at or above 3.5?}

%% ------------------------- HIGH SV FAST PICK -------------------------------
SV35 -->|Yes| PG1{Apply priority guard\nCandidate not in top 3 and\n(top3 SV >= 0.5 and\ncandidate SV minus top3 SV <= 0.75)\nexcept if candidate SV >= 4.1}
PG1 -->|Guard triggers| PG1_TOP3[[Prefer top 3 tile instead\nTRAIN MAX]]
PG1 -->|Guard not trigger| PG1_TAKE[[TRAIN MAX on candidate]]
SV35 -->|No| URA{Final season URA?}

%% --------------------------- URA FINALE ------------------------------------
URA -->|Yes| URA_BRANCH{URA rules}
URA_BRANCH -->|Any hint present| URA_HINT[[TAKE HINT]]
URA_BRANCH -->|Else any top 3 stat below 600| URA_600[[TRAIN MAX on that stat to push to 600]]
URA_BRANCH -->|Else all top 3 at or above 600 and some below 1170| URA_1170[[TRAIN MAX push closest to 1200 but below 1170]]
URA_BRANCH -->|Else no thresholds hit and WIT at or above 1.75| URA_WIT[[TRAIN WIT soft skip]]
URA_BRANCH -->|Else| AFTER_URA[Continue]
URA -->|No| AFTER_URA[Continue]

%% ----------------------------- MOOD GATE -----------------------------------
AFTER_URA --> MOOD{Mood below minimal NORMAL and below GREAT?}
MOOD -->|Yes| RECREATION[[RECREATION]]
MOOD -->|No| SUM1{Summer in next turn?}

%% ---------------------------- SUMMER CLOSE ---------------------------------
SUM1 -->|Yes and energy 75 to 96| SUM1_WIT[[TRAIN WIT soft skip]]
SUM1 -->|Yes and energy at or below 70| SUM1_REST[[REST]]
SUM1 -->|Yes and energy > 96| SUM1_SKIP[Skip rest and continue]
SUM1 -->|No| SUM2{Summer in two or fewer turns and energy at or below 90?}

SUM2 -->|Yes and WIT SV at or above 0.5| SUM2_WIT[[TRAIN WIT]]
SUM2 -->|Yes but no WIT value| AFTER_SUM[Continue]
SUM2 -->|No| AFTER_SUM[Continue]

%% ----------------------------- GOOD SV -------------------------------------
AFTER_SUM --> SV25{Any allowed tile\nSV at or above 2.5?}
SV25 -->|Yes| PG2{Apply priority guard same rules}
PG2 -->|Guard triggers| PG2_TOP3[[Prefer top 3 tile\nTRAIN MAX]]
PG2 -->|Guard not trigger| PG2_TAKE[[TRAIN MAX]]
SV25 -->|No| G1RACE{Prioritize G1 is on\nand not junior year\nand not final season\nand G1 today\nand not skip race?}

%% ----------------------------- G1 RACE -------------------------------------
G1RACE -->|Yes and race_if_no_good_value off and there is no good training SV>0| G1_TRAIN[[TRAIN MAX best available even if small]]
G1RACE -->|Yes otherwise| RACE_G1[[RACE]]
G1RACE -->|No| DIRECTOR{Director rule window\nSenior year only\nMonth Jan Feb Mar needs blue\nMonth Sep Oct Nov Dec not yellow or max}

%% --------------------------- DIRECTOR RULE ---------------------------------
DIRECTOR -->|Director tile stat in top 3 or director color orange\nand not capped unless orange\nand risk ok| TAKE_DIR[[TRAIN DIRECTOR]]
DIRECTOR -->|Else| WIT_RB{Any WIT rainbow and WIT at or above 1.5?}

%% ---------------------------- WIT RAINBOW ----------------------------------
WIT_RB -->|Yes| WIT_RB_TAKE[[TRAIN WIT]]
WIT_RB -->|No| ENERGY{Energy at or below 35 percent?}

%% ----------------------------- ENERGY REST ---------------------------------
ENERGY -->|Yes| REST_LO[[REST]]
ENERGY -->|No| WIT_SOFT{Soft skip with WIT\nRainbow present or WIT at or above 1.5?}

WIT_SOFT -->|Yes and rainbow present| WIT_ANY[[TRAIN WIT best available]]
WIT_SOFT -->|Yes and no rainbow but WIT at or above 1.5| WIT_15[[TRAIN WIT]]
WIT_SOFT -->|No| WIT_LOW{Any WIT at or above 1.75?}

WIT_LOW -->|Yes| WIT_175[[TRAIN WIT low gate]]
WIT_LOW -->|No| SV_TOP3_175{Any top 3 priority tile\nSV at or above 1.75?}

%% ------------------------- LATE TRAINING PICK ------------------------------
SV_TOP3_175 -->|Yes| PG3{Apply priority guard same rules}
PG3 -->|Guard triggers| PG3_TOP3[[Prefer that top 3 tile\nTRAIN MAX]]
PG3 -->|Guard not trigger| PG3_TAKE[[TRAIN MAX]]
SV_TOP3_175 -->|No| MOOD2{Mood below GREAT and not near mood up event?}

%% ------------------------- MOOD RECOVERY PASS ------------------------------
MOOD2 -->|Yes and summer and energy at or below 65| REC_SUM[[RECREATION]]
MOOD2 -->|Yes and not summer and energy at or below 90| REC_NOSUM[[RECREATION]]
MOOD2 -->|No or gates not met| RACE_GATE{Not summer and energy at or above 68 and not pre debut or not junior and not final season?}

%% ------------------------------- RACE GATE ---------------------------------
RACE_GATE -->|Yes and not junior and not pre debut and not final and not skip and race_if_no_good_value off and there is good training| RACE_SKIP[[TRAIN MAX instead of race]]
RACE_GATE -->|Yes otherwise| RACE_FREE[[RACE]]
RACE_GATE -->|No| FALLBACK{Fallback path}

%% ------------------------------- FALLBACKS ---------------------------------
FALLBACK -->|Summer and some WIT exists| FB_WIT[[TRAIN WIT best available]]
FALLBACK -->|Energy at or below 70| FB_REST[[REST]]
FALLBACK -->|Any allowed training exists| FB_TRAIN[[TRAIN MAX best allowed]]
FALLBACK -->|None| NOOP[[NOOP]]
